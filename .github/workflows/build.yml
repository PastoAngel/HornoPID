name: Build Horno Control (Production)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  # Versiones fijas para estabilidad
  PYTHON_VERSION: '3.10'
  FLUTTER_VERSION: '3.22.2'
  JAVA_VERSION: '17'
  
  # Configuración del proyecto
  PROJECT_NAME: "HornoPID"
  PRODUCT_NAME: "HornoControl"

jobs:
  # -----------------------------------------------------------------
  # TRABAJO 1: ANDROID (APK)
  # -----------------------------------------------------------------
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configurar Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Configurar Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Instalar Dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flet

      - name: Compilar APK
        # --verbose: Para ver detalles si falla
        # build/apk: Es donde Flet deja el archivo final automáticamente
        run: |
          flet build apk --project "${{ env.PROJECT_NAME }}" --product "${{ env.PRODUCT_NAME }}" --verbose

      - name: Subir APK a GitHub
        uses: actions/upload-artifact@v4
        with:
          name: HornoControl-Android
          path: build/apk/*.apk
          if-no-files-found: error

# -----------------------------------------------------------------
  # TRABAJO 2: WINDOWS (EXE) - CORREGIDO
  # -----------------------------------------------------------------
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - name: Checkout Código
        uses: actions/checkout@v4

      - name: Configurar Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Configurar Flutter ${{ env.FLUTTER_VERSION }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: Instalar Dependencias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flet

      - name: Compilar Windows EXE
        # --- AQUÍ ESTÁ EL ARREGLO ---
        # 1. PYTHONIOENCODING: utf-8 -> Obliga a Python a aceptar símbolos como ●
        # 2. --no-rich-output -> Intenta evitar gráficos complejos
        env:
          PYTHONIOENCODING: utf-8
        run: |
          flet build windows --project "${{ env.PROJECT_NAME }}" --product "${{ env.PRODUCT_NAME }}" --verbose --no-rich-output

      - name: Subir EXE a GitHub
        uses: actions/upload-artifact@v4
        with:
          name: HornoControl-Windows
          path: build/windows
          if-no-files-found: error