name: Compilar Flet App (Diagn칩stico)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # -----------------------------------------------------------------
  # TRABAJO 1: ANDROID (Con Diagn칩stico de Archivos)
  # -----------------------------------------------------------------
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Java (Necesario para Android)
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: Instalar Dependencias
        run: |
          pip install -r requirements.txt
          pip install flet

      - name: Compilar APK (Modo Verbose)
        # El flag -v nos dir치 si falla por algo interno
        run: |
          flet build apk --project "HornoPID" --product "HornoControl" -v

      - name: 游댌 DIAGN칍STICO - 쮻칩nde est치 el archivo?
        # Este paso nos mostrar치 en el log todos los archivos creados
        if: always() 
        run: |
          echo "Buscando archivos APK..."
          find . -name "*.apk"
          echo "Listando carpeta build..."
          ls -R build || echo "La carpeta build no existe (La compilaci칩n fall칩 totalmente)"

      - name: Subir APK (B칰squeda Recursiva)
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: HornoPID-Android
          # Buscamos el APK donde sea que haya ca칤do
          path: |
            **/*.apk
            !**/debug/**/*.apk

  # -----------------------------------------------------------------
  # TRABAJO 2: WINDOWS (Con Diagn칩stico)
  # -----------------------------------------------------------------
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'

      - name: Instalar Dependencias
        run: |
          pip install -r requirements.txt
          pip install flet

      - name: Compilar EXE (Sin espacios en nombre)
        env:
          PYTHONIOENCODING: utf-8
        # Simplificamos el nombre del producto para evitar errores de espacios
        run: |
          flet build windows --project "HornoPID" --product "HornoControl" -v

      - name: 游댌 DIAGN칍STICO WINDOWS
        if: always()
        run: |
          echo "Buscando archivos EXE..."
          Get-ChildItem -Path build -Recurse -Filter *.exe -ErrorAction SilentlyContinue

      - name: Subir EXE
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: HornoPID-Windows
          # Ruta m치s generosa para encontrarlo
          path: build/windows/**/runner/Release/**/*j